import { ConnectButton } from '@rainbow-me/rainbowkit';
import type { NextPage } from 'next';
import Head from 'next/head';
import styles from '../styles/Home.module.css';
import { useEffect, useState } from 'react';
import { useAccount } from 'wagmi';
import { abi } from '../abi';
import { readContract, writeContract } from '@wagmi/core'
import { config } from '../wagmi';
import { getRandomWord } from '../randomWord';
import { keccak256, toBytes } from "viem";
import { tokenAbi } from '../tokenAbi';

const TOKEN_ADDRESS = process.env.NEXT_PUBLIC_TOKEN_ADDRESS as `0x${string}`
const CONTRACT_ADDRESS = process.env.NEXT_PUBLIC_CONTRACT_ADDRESS as `0x${string}`

const ONE = BigInt(10**18);
const APPROVE_AMOUNT = BigInt(500) * ONE;
const MINT_AMOUNT = BigInt(5) * ONE;

const Home: NextPage = () => {
  const account = useAccount();
  const [word, setWord] = useState('');
  const [guess, setGuess] = useState('');
  const [message, setMessage] = useState('');
  const [triesLeft, setTriesLeft] = useState(1);
  const [gameOver, setGameOver] = useState(false);

  const setup = async () => {
  if (!account?.address) return;

  try {
    const randomWord = getRandomWord().toLowerCase();
    setWord(randomWord);

    const wallet = account.address as `0x${string}`;

    // 1) Approve once
    await writeContract(config, {
      address: TOKEN_ADDRESS,
      abi: tokenAbi,
      functionName: "approve",
      args: [CONTRACT_ADDRESS, APPROVE_AMOUNT],
    });

    // 2) Mint tokens to player
    await writeContract(config, {
      address: TOKEN_ADDRESS,
      abi: tokenAbi,
      functionName: "mintToken",
      args: [wallet, MINT_AMOUNT],
    });

    // 3) Start game 
    await writeContract(config, {
      address: CONTRACT_ADDRESS,
      abi: abi,
      functionName: "startGame",
      args: [wallet],
    });

    // 4) Set target word
    const hashWord = keccak256(toBytes(randomWord)) as `0x${string}`;
    await writeContract(config, {
      address: CONTRACT_ADDRESS,
      abi: abi,
      functionName: "setTargetWord",
      args: [hashWord],
    });

    await getTries();

  } catch (err: any) {
    console.error("setup failed", err);
    }
  };

  const getTries = async () => {
      const result = await readContract(config, {
        address: CONTRACT_ADDRESS as `0x${string}`,
        abi,
        functionName: "getTries",
        args: [account.address as `0x${string}`],
      });

      setTriesLeft(Number(result));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!word || gameOver) return;

    const normalizedGuess = guess.trim().toLowerCase();
    const hashGuess = keccak256(toBytes(normalizedGuess)) as `0x${string}`;
    const wallet = account.address as `0x${string}`

    writeContract(config,{
        address: CONTRACT_ADDRESS,
        abi: abi,
        functionName: "tryGuess",
        args:[wallet,hashGuess]
    })

    if (normalizedGuess === word) {
      setMessage('Correct!');
      setGameOver(true);
      return;
    }

    await getTries();

    if (triesLeft <= 0) {
      setMessage(`You lose! The word was "${word}".`);
      setGameOver(true);
    }

    setGuess('');
  };

  const handleReset = async () => {
  setGameOver(false);
  setMessage("");
  await setup();
};

  useEffect(() => {
  if (account && account.isConnected) {
    (async () => {
      await setup();
    })();
  } else {
    setWord("");
    setTriesLeft(0);
    setGameOver(false);
    setMessage("");
  }
}, [account]);

  return (
    <div className={styles.container}>
      <Head>
        <title>Tokle</title>
        <meta
          content="Generated by @rainbow-me/create-rainbowkit"
          name="description"
        />
        <link href="/favicon.ico" rel="icon" />
      </Head>

    <main className={styles.main}>
      <ConnectButton />
      
      <h1 className={styles.title}>Welcome to Tokle!</h1>
      
      <p className={styles.description}>
        A <a href="https://www.nytimes.com/games/wordle/index.html">Wordle</a>{' '}
        like game with Web3!
      </p>

      {account.address === CONTRACT_ADDRESS &&  
      <p>Daily word: {word ? word : 'Loading...'} (for testing)</p>
      }

      <form onSubmit={handleSubmit}>
        <input
          type="text"
          value={guess}
          onChange={(e) => setGuess(e.target.value)}
          placeholder="Enter your guess"
          className="guess-input"
          disabled={gameOver}
        />
        <button type="submit" className="guess-button" disabled={gameOver || !word}>
          Guess
        </button>
      </form>

      <p className="message">{message}</p>

      {gameOver && (
        <button onClick={handleReset} className="reload-button">
          Try Again
        </button>
      )}
      </main>

      <footer className={styles.footer}>
        <a href="https://rainbow.me" rel="noopener noreferrer" target="_blank">
          Made with ‚ù§Ô∏è by your frens at üåà
        </a>
      </footer>
    </div>
  );
};

export default Home;
